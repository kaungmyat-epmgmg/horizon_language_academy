
-- ======================================
-- CLEAN DROP (dependents -> parents)
-- ======================================
SET FOREIGN_KEY_CHECKS = 0;

DROP TABLE IF EXISTS activity_log;
DROP TABLE IF EXISTS feedback;
DROP TABLE IF EXISTS admin_class;
DROP TABLE IF EXISTS student_class;
DROP TABLE IF EXISTS quiz;
DROP TABLE IF EXISTS powerpoint_file;
DROP TABLE IF EXISTS lecture_note;
DROP TABLE IF EXISTS visa_status;
DROP TABLE IF EXISTS document;
DROP TABLE IF EXISTS visa_application;
DROP TABLE IF EXISTS class;
DROP TABLE IF EXISTS programme;
DROP TABLE IF EXISTS users;
DROP TABLE IF EXISTS visa_support_officer;
DROP TABLE IF EXISTS student;
DROP TABLE IF EXISTS teacher;
DROP TABLE IF EXISTS admin;

SET FOREIGN_KEY_CHECKS = 1;

-- ======================================
-- CORE ROLE TABLES
-- ======================================
CREATE TABLE admin (
  admin_id     VARCHAR(50) PRIMARY KEY,
  admin_name   VARCHAR(100) NOT NULL,
  admin_email  VARCHAR(100) UNIQUE,
  admin_ph_no  VARCHAR(20)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE teacher (
  teacher_id    VARCHAR(50) PRIMARY KEY,
  teacher_name  VARCHAR(100) NOT NULL,
  teacher_email VARCHAR(100) UNIQUE,
  teacher_ph_no VARCHAR(20)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE student (
  student_id    VARCHAR(50) PRIMARY KEY,
  student_name  VARCHAR(100) NOT NULL,
  student_email VARCHAR(100) UNIQUE,
  student_ph_no VARCHAR(20)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE visa_support_officer (
  officer_id    VARCHAR(50) PRIMARY KEY,
  officer_name  VARCHAR(100) NOT NULL,
  officer_email VARCHAR(100) UNIQUE,
  officer_ph_no VARCHAR(20)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ======================================
-- USERS (now includes role column)
-- ======================================
CREATE TABLE users (
  user_id     VARCHAR(50) PRIMARY KEY,
  role        ENUM('Admin','Teacher','Student','VisaSupportOfficer') NOT NULL,
  email   VARCHAR(50),
  password VARCHAR (50)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ======================================
-- PROGRAMME & CLASS
-- ======================================
CREATE TABLE programme (
  programme_id   VARCHAR(50) PRIMARY KEY,
  programme_name VARCHAR(100) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE class (
  class_id     VARCHAR(50) PRIMARY KEY,
  class_name   VARCHAR(100) NOT NULL,
  class_date   DATE,
  teacher_id   VARCHAR(50),
  programme_id VARCHAR(50),
  FOREIGN KEY (teacher_id) REFERENCES teacher(teacher_id)
    ON UPDATE CASCADE ON DELETE SET NULL,
  FOREIGN KEY (programme_id) REFERENCES programme(programme_id)
    ON UPDATE CASCADE ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ======================================
-- VISA APPLICATION SYSTEM
-- ======================================
CREATE TABLE visa_application (
  visa_application_id VARCHAR(50) PRIMARY KEY,
  visa_applicant_name VARCHAR(100) NOT NULL,
  visa_start_date DATE,
  visa_end_date   DATE,
  passport_number VARCHAR(50),
  officer_id      VARCHAR(50),
  FOREIGN KEY (officer_id) REFERENCES visa_support_officer(officer_id)
    ON UPDATE CASCADE ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE document (
  document_id         VARCHAR(50) PRIMARY KEY,
  document_type       VARCHAR(100),
  received_date       DATE,
  visa_application_id VARCHAR(50),
  FOREIGN KEY (visa_application_id) REFERENCES visa_application(visa_application_id)
    ON UPDATE CASCADE ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE visa_status (
  status_id           VARCHAR(50) PRIMARY KEY,
  status              VARCHAR(50) NOT NULL,
  status_date         DATE,
  visa_application_id VARCHAR(50),
  FOREIGN KEY (visa_application_id) REFERENCES visa_application(visa_application_id)
    ON UPDATE CASCADE ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ======================================
-- LEARNING MATERIALS & ASSESSMENTS
-- ======================================
CREATE TABLE lecture_note (
  lecture_note_id   VARCHAR(50) PRIMARY KEY,
  lecture_note_name VARCHAR(100),
  upload_date       DATE,
  class_id          VARCHAR(50),
  FOREIGN KEY (class_id) REFERENCES class(class_id)
    ON UPDATE CASCADE ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE powerpoint_file (
  ppf_id      VARCHAR(50) PRIMARY KEY,
  ppf_name    VARCHAR(100),
  upload_date DATE,
  class_id    VARCHAR(50),
  FOREIGN KEY (class_id) REFERENCES class(class_id)
    ON UPDATE CASCADE ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE quiz (
  quiz_id     VARCHAR(50) PRIMARY KEY,
  quiz_name   VARCHAR(100),
  upload_date DATE,
  class_id    VARCHAR(50),
  FOREIGN KEY (class_id) REFERENCES class(class_id)
    ON UPDATE CASCADE ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ======================================
-- MANY-TO-MANY LINKS
-- ======================================
CREATE TABLE student_class (
  student_class_id VARCHAR(50) PRIMARY KEY,
  student_id VARCHAR(50) NOT NULL,
  class_id   VARCHAR(50) NOT NULL,
  FOREIGN KEY (student_id) REFERENCES student(student_id)
    ON UPDATE CASCADE ON DELETE CASCADE,
  FOREIGN KEY (class_id) REFERENCES class(class_id)
    ON UPDATE CASCADE ON DELETE CASCADE,
  UNIQUE KEY uq_student_class (student_id, class_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE admin_class (
  admin_class_id VARCHAR(50) PRIMARY KEY,
  admin_id VARCHAR(50) NOT NULL,
  class_id VARCHAR(50) NOT NULL,
  FOREIGN KEY (admin_id) REFERENCES admin(admin_id)
    ON UPDATE CASCADE ON DELETE CASCADE,
  FOREIGN KEY (class_id) REFERENCES class(class_id)
    ON UPDATE CASCADE ON DELETE CASCADE,
  UNIQUE KEY uq_admin_class (admin_id, class_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ======================================
-- FEEDBACK & ACTIVITY LOG
-- ======================================
CREATE TABLE feedback (
  feedback_id VARCHAR(50) PRIMARY KEY,
  student_id  VARCHAR(50),
  class_id    VARCHAR(50),
  rating      INT,
  comment     TEXT,
  date        DATE,
  FOREIGN KEY (student_id) REFERENCES student(student_id)
    ON UPDATE CASCADE ON DELETE SET NULL,
  FOREIGN KEY (class_id) REFERENCES class(class_id)
    ON UPDATE CASCADE ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE activity_log (
  log_id      VARCHAR(50) PRIMARY KEY,
  user_id     VARCHAR(50),
  action_type VARCHAR(50),
  action_date DATE,
  description TEXT,
  FOREIGN KEY (user_id) REFERENCES users(user_id)
    ON UPDATE CASCADE ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
